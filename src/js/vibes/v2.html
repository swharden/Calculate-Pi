<html>
<body>

<div id="status"></div>
<div id="output" style="font-family: monospace; word-wrap: break-word;"></div>

<script>
function getStatusMessage(maxDigits, startTime, digitsCalculated){
	//const digitsCalculated = Math.max(0, maxDigits);
	const elapsedSeconds = (performance.now() - startTime) / 1000;
	const rate = elapsedSeconds > 0 ? (digitsCalculated / elapsedSeconds).toFixed(1) : '0.0';
	return `Calculated ${digitsCalculated.toLocaleString()} of ${maxDigits.toLocaleString()} digits (${elapsedSeconds.toFixed(3)} sec, ${rate} digits/sec)`; 
}

function streamPiDigits(maxDigits) {
			
    const output = document.getElementById("output");
    const status = document.getElementById("status");

    const startTime = performance.now();

    const len = Math.floor((10 * maxDigits) / 3);
    const a = new Array(len + 1).fill(2);   // 1-based array in original
    let nines = 0;
    let predigit = 0;

    for (let j = 1; j <= maxDigits; j++) {
        let q = 0;

        for (let i = len; i >= 1; i--) {
            const x = 10 * a[i] + q * i;
            a[i] = x % (2 * i - 1);
            q = Math.floor(x / (2 * i - 1));
        }

        a[1] = q % 10;
        q = Math.floor(q / 10);

        if (q === 9) {
            nines++;
        }
        else if (q === 10) {
            output.textContent += (predigit + 1);

            for (let k = 1; k <= nines; k++)
                output.textContent += "0";

            predigit = 0;
            nines = 0;
        }
        else {
            if (j > 1)
                output.textContent += predigit;
            if (j === 2)
                output.textContent += ".";

            predigit = q;

            if (nines !== 0) {
                for (let k = 1; k <= nines; k++)
                    output.textContent += "9";
                nines = 0;
            }
        }
		
		status.textContent = getStatusMessage(maxDigits, startTime, j);
    }
}

streamPiDigits(5000);

</script>

</body>
</html>